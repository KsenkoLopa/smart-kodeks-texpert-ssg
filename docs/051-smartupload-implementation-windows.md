# Внедрение СМАРТ-мониторинга (smartupload) у клиентов

В данной главе описан процесс внедрения smartupload на установке у клиента-пользователя ИСС.
Процесс сей несложный, не требует каких-то специальных навыков и при "набитой руке" выполняется в среднем минут за 15-20, 
а то и быстрее.

СМАРТ-мониторинг (smartupload) условно можно разделить на 2 части:
- скрипт smartupload.bat (для ОС Windows) или smartupload.sh (для ОС Linux);
- вспомогательная общедоступная бесплатная утилита Сurl.

Скрипт smartupload выполняет следующие функции:
- получение из текущей установки файла sysinfo;
- сохранение его в заданную для скрипта рабочую папку; 
- отправка в СМАРТ для последующей обработки. 

Скрипт написан на языке shell cmd. 
Скрипт содержит в себе параметры, обеспечивающие сортировку файлов по дистрибьюторам-пользователям СМАРТа и установкам 
каждого конкретного дистрибьютора.

Скрипт работает вместе с утилитой Curl. 
Ее функционал - обеспечивать отправку собранного отчета sysinfo по заданному в скрипте адресу к обработчику СМАРТа. 
Больше описания утилиты Curl можно найти [тут](https://ru.wikipedia.org/wiki/CURL) или где угодно на просторах Интернета.

Весь процесс внедрения условно можно разделить на несколько этапов.
Для удобства навигации оглавление представлено ниже:

Процесс внедрения состоит из следующих этапов:
- [Подготовка скрипта smartupload, его размещение](051-smartupload-implementation-windows.md#подготовка-скрипта-smartupload)
- [Скачивание утилиты Curl](051-smartupload-implementation-windows.md#скачивание-утилиты-curl)
- [Разворачивание утилиты Curl, внедрение скрипта](051-smartupload-implementation-windows.md#разворачиваyие-утилиты-curl-внедрение-скрипта)
- [Тестовый запуск, оценка результатов запуска](051-smartupload-implementation-windows.md#тестовый-запуск-оценка-результатов-запуска)
- [Автоматизация исполнения скрипта](051-smartupload-implementation-windows.md#автоматизация-исполнения-скрипта)

Для целей эффективности и быстроты внедрения специалисту, выполняющему внедрение smartupload желательно быть на уровне 
Уверенного Пользователя ПК (для ОС Windows).

В случае затруднений всегда можно обратиться к разработчику СМАРТа. Ну и гугл в помощь, да.

Процесс внедрения smartupload в ОС Windows и ОС Linux радикально ничем не отличается, однако имеет свои небольшие нюансы.

Если тебе нужно внедрить smartupload в ОС Windows, то читай [дальше.](051-smartupload-implementation-windows.md#подготовка-скрипта-smartupload)

Если тебе нужно внедрить smartupload в ОС Linux, то тебе [сюда.](052-smartupload-implementation-linux.md)

## Подготовка скрипта smartupload

Скрипт, ввиду его функционала, содержит исходные данные, индивидуальные для каждой конкретной установки, которую необходимо 
поставить под контроль СМАРТа.

![Пример скрипта дл внедрения smartupload](img/implementation/smartupload-example.png "Пример скрипта дл внедрения smartupload")

Как видно из скриншота - есть некоторые данные, которые необходимо поменять, заменив русские буквы на английские:
- АДРЕСПК:ПОРТ - здесь заменить на адрес ПК, на котором развернута установка, подлежащая мониторингу.
Адрес может быть как в виде IP-адреса, так и в виде имени компьютера в сети.

Этот параметр задается и контролируется пользователем СМАРТа.

Если с течением времени возникла необходимость поменять адрес и/или порт, через который должен будет работать ПК, то после 
его замены в административной части самого ПК, актуальный адрес и/или порт также необходимо прописать и в этом скрипте вручную.

---

***ВАЖНО!!!*** Если скрипт размещается на физически той же машине, на которой развернут ПК ТЭ, то IP-адрес следует писать 
127.0.0.1:ПОРТ. Не рекомендуется извращаться с вписываением IP-адреса из пула адресов локальной сети, равно как не следует 
писать ИМЯ-МАШИНЫ:ПОРТ, так как могут быть разного рода ограничения и неожиданности - локальные IP-адреса меняются очень 
часто доменным сервером.

---

- НАЗВАНИЕКЛИЕНТА - имя клиента для последующей корректной сортировки его обработчиком СМАРТа и успешной идентификации 
его потом в Grafana на ее таблицах и графиках.

Этот параметр задается и контролируется пользователем СМАРТа.

Допускает использовать: 
- ТОЛЬКО английские буквы верхнего и нижнего регистра;
- использовать цифры;
- допускается использовать спецсимволы, не противоречащие общим правилам для имен файлов в любой ОС.

![Недопустимые символы в имени файла или каталога](img/implementation/symbols-names.png "Недопустимые символы в имени файла или каталога")

Имя должно быть максимально понятным и сходу однозначно трактуемым.
Не выдумывай сложного иначе потом самому будет сложно.

Имя клиента здесь должно быть идентично имени клиента, подаваемого в *.csv файле разработчику СМАРТа для регистрации в системе.

- ИМЯДИСТРИБЬЮТОРА - имя твоего предприятия-дистрибьютора, с которым заключен договор на СМАРТ-мониторинг.
Этот параметр задается разработчиком СМАРТа и передается пользователю СМАРТа для внесения в скрипты.

Этот параметр в скриптах служит своего рода меткой, необходимой для корректной сортировки всех приходящих отчетов обработчиком 
СМАРТа.

Параметр задается по маске XXXXYYYYYYYY, где:
    - XXXX это код дистрибьютора;
    - YYYYYYYY это краткое, но однозначно трактуемое имя дистрибьютора.

- ТОКЕНБЕЗОПАСНОСТИ - параметр, служащий проверочным ключом при сортировке и валидации поступающих в обработчик СМАРТа отчетов.
Уникален для каждого дистрибьютора.
Един для всех скриптов СМАРТа у каждого дистрибьютора.
Не подлежит обмену между дистрибьюторами, так как может привести к нарушению процесса проверки и сортировки приходящих 
отчетов внутри обработчика СМАРТа.

Этот параметр задается и контролируется разработчиком СМАРТа и передается пользователю СМАРТа для внесения последним этого 
параметра в скрипты СМАРТа.

Подготовленный скрипт smartupload может находиться:
- на той же машине (виртуальной или физической), где развернут ПК;
- где-то на локальной сети, в которой доступен ПК;
ОС не имеет значения.

Для удобства и повышения быстродействия рекомендуется его размещать на той же машине, на которой развернут ПК.
Можно даже в той же директории, где развернут ПК.
Работе самого ПК это НИКАК не помешает.

Для удобства и однозначности восприятия папку с файлами для smartupload рекомендуется так и назвать - smartupload.

НАСТОЯТЕЛЬНО рекомендуется в имени каталога для smartupload использовать ТОЛЬКО английские буквы, верхнего или нижнего 
регистра, без цифр, без спец.символов.

Не выдумывай здесь сложного и витиеватого, в этом нет никакой нужды.

## Скачивание утилиты Curl

Вторая часть smartupload это утилита Сurl.
Ее функционал - отправлять собранный через smartupload отчет sysinfo по заданному маршруту в обработчик СМАРТа.

Утилита Curl бесплатная и относится к категории свободного ПО.

Скачать ее можно с ее официального ресурса: https://curl.se/download.html

На странице представлены архивы и приложения для установки практически по всем известным или менее известным операционным средам, существующим на данный момент.

Для целей внедрения утилиты Curl рядом с smartupload необходимо скачать АРХИВ утилиты, подходящей под твою ОС.
Сохранить архив можно в ту же папку, в которой лежит скрипт smartupload. 
Так можно сделать для собственного удобства.
Впрочем, ты можешь сохранить архив куда угодно на машине с ПК.

Для удобства поиска желаемого архива на сайте утилиты используй Crtl+F (для поиска по ключевым словам на странице сайта).

## Разворачиваyие утилиты Curl, внедрение скрипта

После загрузки архива, распакуй его там же, где лежит сам архив.
Должно по итогу это выглядеть вот так:

![Расположение Curl](img/implementation/curl-archive.png "Расположение Curl")

Далее тебе нужно содержимое папки bin. 
Оно находится в разархивированном каталоге.
Содержимое папки копируешь в тот же каталог, в котором находится скрипт smartupload.
Должно по итогу это выглядеть вот так:

![Перенос Curl](img/implementation/curl-placement.png "Перенос Curl")

## Тестовый запуск, оценка результатов запуска

После того как ты все разместил там где требуется, можно попробовать запустить скрипт smartupload.bat (запускать от имени администратора) и оценить результаты тестового запуска.

Что делаем:
- Необходимо запустить командную строку Windows от имени администратора.

Для этого нажимаем кнопку "Пуск", далее в строке поиска приложения набираем cmd. 
В предложенных вариантах видим приложение cmd.exe, кликаем по нему правой кнопкой мыши и в выпавшем меню выбираем "Запуск от имени администратора".

![Запуск командной строки](img/implementation/cmd-windows.png "Запуск командной строки")

Откроется окно командной строки Windows с отображением активного пути по умолчанию.
Нужно перейти в директорию, где лежит smartupload.bat, скорректированный под клиента.

![В командной строке](img/implementation/cmd-open-bat.png "В командной строке")

Путь показан как пример.
В твоем случае он будет отличаться от того, который в примере.

И вот теперь нажать на Enter, отправив скрипт на исполнение.

В результате в консоли можно будет наблюдать вот такой результат:

![Успешное выполнение скрипта](img/implementation/cmd-result-200-OK.png "Успешное выполнение скрипта")

Как можно заметить, в результатах можно увидеть HTTP-коды результатов.
Если видишь код 200 - все ок, скрипт отработал успешно.
Можешь еще, для очистки совести, уточнить у разработчика СМАРТа, что твой отчет действительно доставлен в обработчик СМАРТа.

Если же видишь код 404 или любой другой HTTP-код, говорящий о сетевых ошибках, то:
- проверь скрипт на предмет ошибок в адресе ПК и/или адресе куда отсылать собранный отчет;
- если в скрипте все верно, а выполнение все равно с ошибкой, то делаешь скриншот, отсылаешь его в чат с разработчиком СМАРТа и далее совместно решаете проблему.

Еще одним фактором успешной отработки скрипта является тот факт, что в той же папке, где находится скрипт, появились файлы: собранный отчет и файл cookies.txt:

![Кроме СМАРТа появились еще файлы](img/implementation/smartupload-folder.png "Кроме СМАРТа появились еще файлы")

При успешности выполнения этого этапа можно переходить к автоматизации последующего исполнения корректного скрипта по расписанию.

## Автоматизация исполнения скрипта

После того как первый тестовый запуск smartupload прошел успешно - можно этот процесс автоматизировать.

В ОС Windows это можно сделать с помощью стандартных средств самой ОС - Планировщик заданий.

![Планировщик заданий](img/implementation/task-scheduler-where.png "Планировщик заданий")

Пуск -> Панель управления -> Администрирование -> Планировщик задач

Далее в планировщике необходимо создать задачу (не выбирать создать ПРОСТУЮ задачу!!!) со следующими настройками (см. картинки ниже):

![Планировщик заданий](img/implementation/task-scheduler-common-settings.png "Планировщик заданий")

Обязательно выставитьПланировщик заданий исполнение вне зависимости от пользователя и с наивысшими правами - при некоторых настройках групповых и локальных политик безопасности, программе может оказаться невозможно писать файлы в свою же папку.
А это недопустимо.

![Планировщик заданий](img/implementation/task-scheduler-triggers.png "Планировщик заданий")

Периодичность выполнения задачи - каждый час, бесконечно.

Здесь важно выдержать хронометраж выполняемых фоновых заданий - чтобы задача smartupload не пересекалась с ежедневными процедурами самого ПК: бэкап, перезапуск, обновление.
В эти моменты ПК может быть недоступен.

![Планировщик заданий](img/implementation/task-scheduler-actions.png "Планировщик заданий")

Здесь задается параметр того, что должно быть выполнено в рамках данной задачи - в нашем случае это "Запуск программы", а именно запуск smartupload.bat.

Пути указываются абсолютные.

---

**ВАЖНО!!!** Обязательно необходимо указать рабочую папку, в которой лежит сам файл smartupload.bat.
Если этого не сделать, то скрипт не сможет сохранить собранный отчет, и, следовательно, его отправить.
Таким образом, скрипт не будет работать как положено.

---

![Планировщик заданий](img/implementation/task-scheduler-conditions.png "Планировщик заданий")

![Планировщик заданий](img/implementation/task-scheduler-extra-settings.png "Планировщик заданий")

На этих двух скриншотах показано, какие еще должны быть выставлены условия для запуска и функционирования задачи.

![Планировщик заданий](img/implementation/task-scheduler-common-settings-password.png "Планировщик заданий")

После всех настроек задачи система спросит пароль, если была выставлена галочка "Выполнять с наивысшими правами".

Если учетка, под которой заводилась задача, обладает локальными правами администратора, то ввести ее пароль.
Иначе - ввести имя и пароль такой учетки, чьи права позволяют завершить выставление задачи в планировщик.

После постановки задачи, успешность ее исполнения можно отследить в журнале планировщика, а также спросив разработчика СМАРТа о регулярности поступления отчетов с этой установки.
Кроме того - если по этой установке стали строиться графики в Grafana - значит все верно настроено.

После загрузки sysinfo на сервер потребуется от 10 минут на его обработку.
На графиках обновлённые данные появятся где-то в этом промежутке.
Аварийные сообщения имеют различный период срабатывания\задержки поэтому появятся позднее.

[Вернуться к началу](050-intro-smartuload-smartstatus.md)

[Вернуться к Оглавлению, если стало страшно](index.md)












