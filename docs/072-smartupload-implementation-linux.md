# Внедрение smartupload в ОС Linux

Общий принцип внедрения практически ничем не отличается от описанного [здесь.](071-smartupload-implementation-windows.md#подготовка-скрипта-smartupload)

Скрипт ***smartupload.sh*** предназначен для получения из текущей инсталляции XML\SQLite файла SYSINFO, 
сохранения его на накопитель, загрузка в СМАРТ для последующей обработки. 
Скрипт написан на языке bash shell. 
Скрипт содержит в себе параметры, обеспечивающие сортировку файлов по дистрибьюторам-пользователям СМАРТа и установкам каждого конкретного дистрибьютора.

## Размещение скрипта smartupload.sh

Перепишите скрипт на любой компьютер, с которого доступен сервер Кодекс.
Где располагается скрипт на накопителе особой роли не играет.
Лучше размещать его в месте, где пользователь его случайно не удалит. Пример: ***/opt/smartupload/***
Или там же, где развернут ПК.
Скрипт будет сохранять данные в текущую директорию, около 20 мегабайт на один сервер. 
Файлы будут обновляться (перезаписываться) при каждом выполнении, т.е. директория расти в размере не будет.

## Скачивание утилиты Curl

Версия curl роли не играет. 
Установите curl пакетным менеджером используемого дистрибутива.

RHEL\Centos\etc

```shell
sudo yum -y install curl
```

Debian\Ubuntu\etc

```shell
sudo apt-get install curl
```

## Описание параметров

[Ничем не отличается от описанного здесь.](071-smartupload-implementation-windows.md#подготовка-скрипта-smartupload)

## Требования к параметрам

[Ничем не отличается от описанного здесь.](071-smartupload-implementation-windows.md#подготовка-скрипта-smartupload)

## Тестовый запуск, оценка результатов запуска

После всех подготовительных работ необходимо провести тестовый запуск скрипта, исполнив его.
По результату исполнения скрипта следует оценить "все ок" или "не ок".

На этапе получения sysinfo с ПК в директории со скриптом появится файл ***НАЗВАНИЕКЛИЕНТА.xml*** (где НАЗВАНИЕКЛИЕНТА - заданное в параметрах имя клиента).
Результат, говорящий что "все ок" в консоли будет выглядеть так:

```shell
.......
< HTTP/1.1 200 OK
< Server: WWW-Kodeks/6.4
< Date: Sun, 22 Aug 2021 11:31:54 UTC
< Content-Type: text/xml; charset=utf-8
< Connection: close
< Transfer-Encoding: chunked
- Closing connection 0
```

- На следующем этапе отправки sysinfo на сервер СМАРТа в консоль будет подобный вывод, означающий, что и на этом этапе "все ок":

```shell
........
< HTTP/1.1 200 OK
< Content-Length: 37
< Content-Type: text/plain; charset=utf-8
< Date: Sun, 22 Aug 2021 11:31:57 GMT
{"ok":true,"path":"/files/ИМЯКЛИЕНТА.xml"}
```

## Проверка, что sysinfo был загружен на сервер СМАРТа

Для проверки, что отчет успешно или неуспешно загружен на сервер СМАРТа, необходимо в консоли выполнить следующую команду:

```shell
curl -H "upload: yes" -H "dealer: ИМЯДИСТРИБЬЮТОРА" -I 'http://smart.uniclass.ru/files/ИМЯКЛИЕНТА.xml?token=ТОКЕНБЕЗОПАСНОСТИ'
...
```
В строке заменить параметры на соответсвующее клиенту (как в скрипте smartupload.sh)/

Если всё ОК - статус "200 ОК"

```shell
curl -H "upload: yes" -H "dealer: Dealer" -I 'http://smart.uniclass.ru/files/ИМЯКЛИЕНТА.xml?token=ТОКЕНБЕЗОПАСНОСТИ'
HTTP/1.1 200 OK
......
```

Если файл не загрузился Статус "404 Not Found"

```shell
curl -H "upload: yes" -H "dealer: Dealer" -I 'http://smart.uniclass.ru/files/ИМЯКЛИЕНТА.xml?token=ТОКЕНБЕЗОПАСНОСТИ'
HTTP/1.1 404 Not Found
.....
```

В случае "404 Not Found" необходимо (последовательно):
- обратиться к части скрипта, отвечающего за отправку sysinfo и проверить корректность введенных данных;
- проверить интернет соединение на предмет ограничений исходящего трафика;
- спросить разработчика СМАРТа о возможных иных проблемах.

## Работа через http proxy сервер

Для настройки работы скрипта smartupload.sh в случаи когда для выхода в интернет 
используется прокси-сервер необходимо передать параметр **-t http_proxy:port**.

```shell
smartupload.sh .... -t proxyserver:port
smartupload.sh .... -t 192.168.0.1:3128
smartupload.sh .... -t user:login@192.168.0.1.:3128
```

После загрузки sysinfo на сервер потребуется от 10 минут на его обработку.
На графиках обновлённые данные появятся где-то в этом промежутке.
Аварийные сообщения имеют различный период срабатывания\задержки поэтому появятся позднее.

[Вернуться к началу](070-intro-smartuload-smartstatus.md)

[Вернуться к Оглавлению, если стало страшно](Readme.md)